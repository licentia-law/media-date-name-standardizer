# CRG
## MDNS Coding Rules & Guidelines (CRG)

본 문서는 MDNS 구현 시 코드 품질/안정성/결정성을 보장하기 위한 규칙이다.

---

## 1. 일반 원칙

1) 원본 비파괴
- 원본 파일을 수정하지 않는다.
- 모든 결과는 [Source]/result/ 아래에서만 생성/수정한다.

2) 결정성(Determinism)
- 동일 입력 → 동일 출력이 되도록 정렬, 카운터 스코프, 중복 suffix 규칙을 고정한다.

3) 실패 격리
- 파일 1개 실패로 전체 중단 금지.
- 파일 단위 try/except + error.log 기록을 기본으로 한다.

4) 사용자 로그는 한글
- 내부 코드는 이벤트 코드 사용 가능하나, UI 출력은 한글만 사용한다.

---

## 2. 코드 스타일/구조

- Python 3.x
- 타입 힌트 사용 권장(핵심 인터페이스/데이터 모델에는 필수)
- 함수는 1가지 책임만 수행
- 모듈 책임 분리:
  - GUI: 이벤트/표시만
  - orchestrator: 순서/파이프라인
  - scanner/date_resolver/naming/convert/metadata: 순수 로직

권장 제한:
- 함수 80 LOC 초과 시 분리 고려
- 파일 400 LOC 초과 시 모듈 분리 고려

---

## 3. 예외 처리/로깅 규칙

- error.log는 반드시 “원인 추적 가능”해야 한다.
- error.log 포함 정보(최소):
  - timestamp, 파일 경로, 단계(convert/meta/name/copy), 예외 메시지, 스택트레이스
- UI에는 스택트레이스를 노출하지 않는다.
  - “오류 발생(오류 로그 확인)” 수준의 요약만 표준.

---

## 4. 외부 도구 호출 규칙(ffmpeg/exiftool)

- subprocess는 반드시 리스트 인자 방식으로 호출(쉘 사용 금지)
- 파일 경로는 공백/특수문자 포함을 전제로 한다.
- 타임아웃 지정(DEV_GUIDE 권장값 준수)
- stdout/stderr 캡처 후 실패 시 error.log에 기록한다.
- 바이너리 경로는 paths.py를 통해서만 얻는다(하드코딩 금지).

---

## 5. 성능/메모리

- 대용량 파일에서 MD5(file_content) 계산이 병목이 될 수 있다.
- v1 기본은 단순 구현(전체 읽기) 허용.
- 단, 해시 함수는 반드시 별도 함수로 분리하여 v1.1에서 스트리밍 해시(청크 읽기)로 쉽게 개선 가능하게 한다.
- UI 업데이트는 과도하게 하지 않는다.
  - 파일 1개당 1회 로그는 허용
  - Progress는 파일당 1회 업데이트로 충분

---

## 6. 스레딩/Tkinter 안전

- Tk 위젯 업데이트는 메인 스레드에서만 수행한다.
- 워커 스레드는 Queue로 이벤트 전달한다.
- GUI는 after()로 큐를 폴링/반영한다.

---

## 7. 파일명 규칙 준수

- PASS 판정은 대/소문자 무관이다.
- 다만 img_ prefix는 반드시 IMG_로 정규화한다.
- 중복 suffix는 언더바 금지:
  - IMG_A1B2C1.jpg, IMG_A1B2C2.jpg ...

---

## 8. 날짜/시간 규칙 준수

- 기준 날짜는 상위 탐색 규칙을 따른다.
- 시간 부여는 09:00:00부터 1초 증가.
- 스코프 키는 DEV_GUIDE 기준으로 고정한다.
- 정렬 규칙 변경은 결과가 바뀌므로:
  - 버전 업 + 릴리스 노트 + 회귀 테스트를 필수로 한다.

---

## 9. 테스트 규칙

- naming/date_resolver는 단위 테스트 필수.
- 최소 1개 스모크 테스트(임시 폴더 기반) 포함.
- 재실행 멱등성 테스트 케이스를 1개 이상 포함(권장).

---

## 10. 문서화

- 공개 함수(모듈 외부에서 호출되는 함수)는 docstring 작성 권장.
- PRD/DEV_GUIDE/CRG와 구현이 충돌하면 PRD를 우선으로 하며, 문서를 즉시 갱신한다.

---

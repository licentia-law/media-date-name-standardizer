# PRD
## Media Date & Name Standardizer (MDNS)
대량 사진/동영상 파일의 **촬영일(메타데이터) 정규화 + 파일명 표준화(해시 기반) + 일부 포맷 변환(PNG/HEIC→JPG)** 데스크톱 GUI 유틸리티 (Python)

---

## 1. 프로젝트 개요 (Project Overview)

### 1.1 프로젝트명
- **Media Date & Name Standardizer (MDNS)**

### 1.2 목표
- 대량의 미디어 파일에 대해:
  1) 폴더명(YYYY-MM-DD) 기준으로 **촬영일 메타데이터를 보정/주입**
  2) 파일명 규칙을 **해시 기반(IMG_XXXXX)** 으로 표준화
  3) 메타데이터 수정이 어려운 일부 포맷은 **JPG로 변환 후 메타데이터 처리**
- 결과를 `result/`에 원본 구조로 생성하여 아카이빙(정렬/검색/백업) 효율을 높인다.

### 1.3 핵심 변경 사항(결정)
- **PNG/HEIC는 JPG로 변환한 뒤** 촬영일 메타데이터를 보정한다.
- **CR3는 ExifTool을 통해** 촬영일 메타데이터를 보정한다.
- 파일명 PASS 패턴은 대/소문자 무관으로 인정하되, **소문자 `img_`는 대문자 `IMG_`로 정규화**한다.
- 중복 파일명 처리 시 `_1` 형태가 아니라 **언더바 없이 숫자를 바로 붙인다**(예: `IMG_A1B2C1.jpg`).
- 로그는 상태코드가 아닌 **한글 문장**으로 출력한다.

---

## 2. 사용자 흐름 (User Flow)

1) 프로그램 실행 → 소스 폴더 선택  
2) [변환 시작] 클릭  
3) 프로그램이 하위 폴더를 재귀적으로 탐색하며 대상 파일을 수집  
4) 각 파일에 대해 다음 처리 수행
   - **기준 날짜 탐색**
     - 파일 경로에서 상위로 올라가며 `YYYY-MM-DD`로 시작하는 폴더명을 탐색
     - 가장 가까운 날짜 폴더를 기준으로 사용(없으면 메타데이터 수정 스킵)
   - **촬영일 메타데이터 보정**
     - 사진: JPG/JPEG는 Exif 수정(piexif)
     - PNG/HEIC: JPG로 변환 후 Exif 수정(piexif)
     - CR3: ExifTool로 촬영일 수정
     - 동영상: MP4/MOV는 ffmpeg로 촬영일 수정(v1)
   - **파일명 표준화**
     - `IMG_식별번호` 형식은 PASS(대소문자 무관)하되, `img_`는 `IMG_`로 변경
     - 그 외는 파일 내용 기반 MD5 해시 5자리로 `IMG_<HASH5>`로 변경
     - 충돌 시 언더바 없이 숫자 suffix 부여
5) 결과물은 원본 폴더 구조를 유지한 채 `[Source]/result/`에 저장(원본 비파괴)
6) 완료 팝업 → 결과 폴더 열기

---

## 3. 범위 (Scope)

### 3.1 In Scope
- 기존 GUI(폴더 선택/진행률/로그/결과 폴더 열기) 최대한 유지
- 재귀 탐색, `result/` 생성 및 원본 구조 유지
- 멀티스레딩으로 GUI 프리징 방지
- 파일 단위 예외 처리 및 오류 로그(`error.log`)
- PNG/HEIC → JPG 변환
- 촬영일 메타데이터 보정(포맷별 정책)
- 파일명 표준화(MD5 기반) + 충돌 처리 + 대문자 정규화
- 로그 한글 출력

### 3.2 Out of Scope (v1)
- 중복 파일 자동 병합/삭제(콘텐츠 동일성 판단)
- 클라우드 연동
- 사진 편집(리사이즈/필터/보정)

---

## 4. 기능적 요구사항 (Functional Requirements)

### FR-01: 폴더 탐색 및 구조 유지 (Directory Traversal)
- 사용자는 GUI에서 소스 루트 폴더를 선택할 수 있어야 한다.
- 하위 폴더를 모든 깊이로 재귀 탐색해야 한다.
- 결과물은 `[Source]/result/` 하위에 **원본과 동일한 폴더 구조로 저장**되어야 한다.
- 원본 파일은 변경/손상되지 않아야 한다(기본: result에 복사/변환본 생성 후 수정).

---

### FR-02: 지원 파일 형식 (Supported Formats)

#### FR-02-1. 대상 확장자
- 이미지: `.jpg`, `.jpeg`, `.png`, `.heic`, `.cr3`
- 동영상: `.mp4`, `.mov`, `.avi`

#### FR-02-2. 메타데이터 촬영일 수정 지원 범위(v1 결정)
- 사진:
  - `.jpg`, `.jpeg`: **직접 Exif 수정 지원(piexif)**
  - `.png`, `.heic`: **JPG로 변환 후 Exif 수정 지원**
  - `.cr3`: **ExifTool로 수정 지원**
- 동영상:
  - `.mp4`, `.mov`: **ffmpeg로 수정 지원**
  - `.avi`: v1에서 메타데이터 수정 제외(파일명만 표준화)

---

### FR-03: 기준 날짜 탐색 규칙 (Folder Date Resolution) — 결정 사항
- 기준 날짜는 파일이 위치한 폴더에서 시작해 **상위로 올라가며** 폴더명에서 날짜를 찾는다.
- 폴더명 날짜 인식 정규식(필수):
  - `^(\d{4}-\d{2}-\d{2})`
- 가장 가까운(가장 하위) 날짜 폴더를 기준으로 한다.
- 기준 날짜를 찾지 못하면:
  - 메타데이터 수정은 수행하지 않고(스킵), 파일명 표준화는 계속 수행한다.

---

### FR-04: 촬영일 메타데이터 보정 (Metadata Correction)

#### FR-04-1. 메타데이터 비교(PASS 조건)
- 기준 날짜가 존재하고,
- 파일의 촬영일 메타데이터가 존재하며,
- 메타데이터의 **YYYY-MM-DD**가 기준 날짜와 동일하면 **PASS(수정하지 않음)**

#### FR-04-2. 메타데이터 수정 조건
- 아래 중 하나이면 수정:
  1) 촬영일 메타데이터가 없음
  2) 촬영일 메타데이터의 YMD가 기준 날짜와 다름

#### FR-04-3. 수정 값 생성 규칙(시간 부여)
- 날짜: 기준 날짜(YYYY-MM-DD)
- 시간: 해당 “기준 날짜 스코프” 내에서 **09:00:00부터 시작**, 파일마다 1초 증가
  - 예: `09:00:00`, `09:00:01`, `09:00:02` …
- 결정성 확보를 위해:
  - 기준 날짜 스코프 내 파일 목록은 **상대경로 + 파일명 오름차순 정렬** 후 적용

#### FR-04-4. 포맷별 처리 방식
- JPG/JPEG:
  - piexif로 `DateTimeOriginal` 중심으로 수정(이미지 재인코딩 금지)
- PNG/HEIC:
  - **JPG로 변환한 결과 파일**에 대해 piexif로 촬영일 설정
  - 원본 PNG/HEIC는 result에 “원본 복사본”을 남길지 여부는 v1에서 기본 정책으로 고정:
    - 기본: 원본은 result에 복사하지 않고 **JPG 결과물만 생성**(아카이빙 목적 상 단순화)
    - (옵션) 원본도 함께 보관이 필요하면 `keep_originals` 옵션으로 확장 가능(Out of Scope v1)
- CR3:
  - ExifTool로 촬영일 태그를 수정(세부 태그 동기화는 개발 가이드에서 정의)
- MP4/MOV:
  - ffmpeg로 `creation_time` 계열 메타데이터 수정(필드 정책은 개발 가이드에서 정의)
- AVI:
  - 메타데이터 수정 스킵(로그 남김)

#### FR-04-5. 실패 처리
- 메타데이터 읽기/쓰기 실패 또는 미지원 포맷:
  - 해당 파일은 메타데이터 수정 실패 로그를 남기고,
  - 파일명 표준화는 계속 수행한다.

---

### FR-05: 파일명 표준화 (Filename Normalization)

#### FR-05-1. PASS 패턴(대소문자 무관) + 대문자 정규화
- PASS 판정 정규식(대소문자 무관):
  - `^img_\d+[a-z]*$` (case-insensitive)
- PASS 예:
  - `IMG_1234`, `img_1234`, `IMG_1234a`, `img_1234ab`
- PASS 처리 규칙(결정 사항):
  - 파일명이 `img_...`(소문자 prefix)인 경우 **`IMG_...`로 변경**한다.
  - `IMG_...`(대문자)는 유지한다.
  - 식별자(숫자/영문)는 유지한다. (영문 대/소문자 정규화 여부는 v1에서 “원본 유지”)

#### FR-05-2. 해시 기반 이름 변경(필수)
- 조건: PASS 패턴에 맞지 않는 모든 파일
- 로직:
  - `hash5 = hashlib.md5(file_content).hexdigest()[:5].upper()`
  - 결과 파일명: `IMG_<HASH5>.<ext>`
- 예: `DSC01234.JPG` → `IMG_A1B2C.JPG`

#### FR-05-3. 중복(충돌) 처리 규칙 — 결정 사항(언더바 없음)
- 결과 파일명이 이미 존재할 경우, 숫자를 **언더바 없이 바로 붙인다**.
  - 예: `IMG_A1B2C.jpg` 존재 → `IMG_A1B2C1.jpg`
  - 그 다음 존재 → `IMG_A1B2C2.jpg` …
- 주의: 원본 해시가 5자리이므로 suffix가 붙으면 길이가 늘어남(허용).

---

### FR-06: 처리 파이프라인 (Processing Pipeline)
파일 1개 처리 권장 순서(원본 비파괴):

1) 대상 확장자 여부 확인  
2) 목적지 폴더(`result/<relative_path>/`) 생성  
3) 아래 포맷별로 결과 파일 생성:
   - JPG/JPEG/MP4/MOV/AVI/CR3: 원본을 result로 복사(copy2 권장)
   - PNG/HEIC: result에 JPG로 변환하여 생성(복사 대신 변환 결과 생성)
4) 메타데이터 보정(가능한 경우만; 기준 날짜 없으면 스킵)
5) 파일명 표준화(PASS/해시/충돌) 및 필요 시 rename
6) 진행률/로그 갱신
7) 파일 단위 오류 시 error.log 기록 후 다음 파일 처리

---

### FR-07: UI 및 피드백 (User Interface)

#### FR-07-1. UI 구성(기존 유지)
- 소스 폴더 선택
- 변환 시작
- 진행률(ProgressBar + %)
- 로그창(실시간)
- 완료 팝업 및 “결과 폴더 열기” 버튼 활성화

#### FR-07-2. 로그 정책(한글 출력) — 결정 사항
- 기존의 상태코드(예: `META_PASS`)는 내부적으로 유지하되,
- 사용자에게 출력되는 로그는 **한글 문장**으로 출력한다.

로그 예시(권장 문구)
- 메타데이터:
  - “메타데이터: 날짜 일치(변경 없음)”
  - “메타데이터: 폴더 날짜로 설정(09:00:xx)”
  - “메타데이터: 기준 날짜 폴더를 찾지 못해 건너뜀”
  - “메타데이터: 지원하지 않는 형식이라 건너뜀”
  - “메타데이터: 수정 실패(오류 로그 확인)”
- 파일명:
  - “파일명: 표준 형식(IMG_) 확인(유지)”
  - “파일명: 소문자 img_ → 대문자 IMG_로 변경”
  - “파일명: 해시 기반으로 변경(IMG_XXXXX)”
  - “파일명: 중복 발생 → 숫자 접미사 추가(…1, …2)”

---

### FR-08: 예외 처리/로깅
- 한 파일 오류로 전체 중단 금지(파일 단위 격리).
- `error.log`에 최소 포함:
  - 시간, 파일 경로, 단계(변환/메타데이터/리네임), 예외 메시지, 스택트레이스(가능 시)
- 처리 요약(권장):
  - 총 파일 수, 성공/실패 수
  - 메타데이터: 변경/유지/스킵/실패 카운트
  - 파일명: 유지/대문자정규화/해시변경/충돌 카운트
  - 변환: PNG→JPG/HEIC→JPG 카운트, 실패 카운트

---

## 5. 비기능적 요구사항 (Non-Functional Requirements)

### NFR-01. 성능/UX
- 수천 장 처리에서도 GUI 프리징이 없어야 하며 멀티스레딩 구조를 유지한다.
- (권장) 워커 스레드 → UI 업데이트는 Queue + `after()`로 전달하여 안정성 확보.

### NFR-02. 안정성(원본 보호)
- 원본은 변경하지 않는다.
- PNG/HEIC는 변환 결과(JPG)를 생성하는 방식이므로, 원본 포맷은 보존되지 않을 수 있음(v1 기본 정책).

### NFR-03. 품질
- JPG/JPEG 메타데이터 수정은 piexif로 Exif만 수정(재인코딩 금지).
- PNG/HEIC→JPG 변환 품질 옵션(예: quality) 기본값은 개발 가이드에서 정하고 v1에서는 고정(옵션화는 추후).

### NFR-04. 멱등성
- 동일 입력 재실행 시:
  - 메타데이터 YMD가 폴더 날짜와 같으면 변경하지 않음
  - 파일명이 IMG_ 규칙이면 유지(단, img_는 IMG_로 1회 정규화 후 안정)
  - 충돌 규칙이 결정적이어야 함(정렬 및 suffix 정책 준수)

---

## 6. 기술 스택/의존성 (Decided)

### 6.1 언어/GUI/패키징
- Python 3.x
- tkinter
- PyInstaller

### 6.2 메타데이터/변환 도구
- JPG/JPEG Exif 수정: **piexif**
- MP4/MOV 메타데이터 수정: **ffmpeg/ffprobe (번들링 동봉)**
- CR3 메타데이터 수정: **ExifTool (번들링 동봉)**
- PNG/HEIC → JPG 변환: 변환 라이브러리(예: Pillow + heif 지원 모듈 등) 선택은 개발 가이드에서 확정

---

## 7. 테스트 계획 (Test Plan)

### 7.1 단위 테스트
- 날짜 폴더 탐색: 상위 탐색 성공/실패, `YYYY-MM-DD_텍스트` 인식
- 파일명 PASS: `IMG_1234`, `img_1234`, `IMG_1234ab` → PASS
- 소문자 정규화: `img_1234` → `IMG_1234`
- MD5 5자리 대문자화: `IMG_<HASH5>`
- 충돌 처리: `IMG_A1B2C` → `IMG_A1B2C1` → `IMG_A1B2C2`

### 7.2 통합 테스트
- 여러 날짜 폴더/하위 폴더 구조 + 혼합 포맷
- PNG/HEIC 변환 후 메타데이터 적용 확인
- CR3 ExifTool 수정 성공/실패 케이스
- mp4/mov ffmpeg 수정 성공/실패 케이스
- avi 메타데이터 스킵 확인
- 로그 한글 출력 및 error.log 기록 확인
- 재실행 시 멱등성 확인

---
